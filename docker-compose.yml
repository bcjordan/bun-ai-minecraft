services:
  opencode:
    image: node:20-slim
    working_dir: /app
    volumes:
      - .:/app
      - ~/.local/share/opencode:/root/.local/share/opencode
      - ~/.local/share/opencode:/root/.opencode
      - ~/.local/share/opencode:/root/.config/opencode
    # Install opencode-ai and run the server
    # We pin the version to ensure stability as requested. 
    # Using 'latest' for now but user can change this.
    # SECURITY NOTE:
    # --hostname 0.0.0.0 binds to all interfaces INSIDE the container so the 'bot' service can reach it.
    # The 'ports' mapping below strictly binds it to 127.0.0.1 on the host, preventing public internet access.
    command: sh -c "export NODE_OPTIONS='--max-old-space-size=4096' && npm install -g opencode-ai && opencode serve --port 4096 --hostname 0.0.0.0"
    ports:
      # Binds ONLY to localhost. External IPs cannot access this port.
      - "127.0.0.1:4096:4096"

  bot:
    build: .
    volumes:
      - .:/app
    environment:
      - MC_HOST=host.docker.internal
      - MC_PORT=9999
      - OPENCODE_URL=http://opencode:4096
      - SKIP_OPENCODE_SERVER=true
      - OPENCODE_API_KEY=${OPENCODE_API_KEY}
      - OPENCODE_PROVIDER=${OPENCODE_PROVIDER}
      - OPENCODE_MODEL=${OPENCODE_MODEL}
    depends_on:
      - opencode
